@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="col-md-12">
    <br />
    <div class="row">
        <div class="col-md-3">
            <div class="card text-center border border-primary">
                <div class="card-header bg-light text-dark">
                    <i class="fa fa-filter fa-lg" aria-hidden="true"></i><b> Filters</b>
                    <i class="fa fa-spinner fa-pulse fa-lg" hidden id="ajaxProgress"></i>
                </div>
                <div class="card-body text-left">
                    <div class="row">
                        <div class="form-group col-md-12">
                            <div class="dropdown">
                                <select id="hospital_types" multiple="multiple">
                                    <option value="1">Hospitals</option>
                                    <option value="2">Comprehensive Centers</option>
                                    <option value="3">Specialized Medical Centers</option>
                                    <option value="4">Peripheral Centers</option>
                                    <option value="5">Primary Centers</option>
                                    <option value="6">Educational Hospitals</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <div class="row">
                                <div class="col-md-9 col-sm-12">
                                    <input type="text" class="form-control" id="TextHospital" placeholder="Select Facility.." disabled="disabled" />
                                </div>
                                <div class="col-md-3 col-sm-12">
                                    <div class="form-check">
                                        <input class="form-check-input " type="checkbox" checked="checked" value="" id="allHospitals">
                                        <label class="form-check-label" for="allHospitals">All</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <table id="selectedFacilitiesTable" class="table table-sm table-hover">

                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="form-group col-md-12">
                            <div class="row">
                                <div class="col-md-9">
                                    <input type="text" placeholder="Select Provider.." class="form-control" id="TextProvider" disabled="disabled" />
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input " type="checkbox" checked="checked" value="" id="allProviders">
                                        <label class="form-check-label" for="allProviders">All</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <label for="reportrange" class="col-form-label">Performance Period</label>
                            <div id="reportrange" class="rounded" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
                                <i class="fa fa-calendar"></i>&nbsp;
                                <span></span> <i class="fa fa-caret-down"></i>
                            </div>

                        </div>
                        <div class="form-group col-md-12">
                            <button class="btn btn-primary btn-block" onclick="refreshCharts();"><i class="fa fa-refresh"></i>&nbsp;Load Charts</button>
                        </div>
                    </div>
                </div>
            </div>

            <br />
            <div class="card text-center border border-primary">
                <div class="card-header bg-light text-dark">
                    <i class="fa fa-bullseye fa-lg" aria-hidden="true"></i><b> Targets</b>
                </div>
                <div class="card-body text-left">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Beds</h6>
                                </div>
                                <div class="col-md-6">
                                    <h6><b><label id="NumberOfBeds" class="text-primary"></label></b></h6>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <i>Targeting 70% occupancy rates and 3 days average LOS</i>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Clinics</h6>
                                </div>
                                <div class="col-md-6">
                                    <h6><b><label id="NumberOfClinics" class="text-primary"></label></b></h6>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <i>Targeting 25 visits daily for clinics operating 3 days a week</i>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Operating Rooms</h6>
                                </div>
                                <div class="col-md-6">
                                    <h6><b><label id="NumberOfOperatingRooms" class="text-primary"></label></b></h6>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <i>Targeting 2 operations daily for theatres working 3 days a week</i>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <br />
            <div class="card text-center border border-primary">
                <div class="card-header bg-light text-dark">
                    <i class="fa fa-info-circle fa-lg" aria-hidden="true"></i><b> Additional Information</b>
                </div>
                <div class="card-body text-left">
                    <h6 class="card-subtitle mb-2 text-muted">Elements for Interpretation</h6>
                    <p class="card-text">
                        Patient care is the reason to be for a healthcare facility.
                        Understanding the population being served and the services they seek from the point of view of the facility will allow for better planning of resources and services in the different facilities.
                    </p>
                </div>
            </div>

        </div>
        <div class="col-md-9">
            <div class="row">
                <div class="col-lg-6 col-md-12">
                    <div class="card border border-primary bg-light" id="outPatientDiv">
                        <div class="card-header bg-primary text-white">
                            <i class="fa fa-star-o fa-pull-left fa-lg" id="starOutpatientChart" data-toggle="tooltip" data-placement="top" title="Star this chart to place it on your dashboard"></i>
                            Outpatient Encounters
                            <i class="fa fa-expand fa-pull-right fa-lg" id="expandOutpatientChart" data-toggle="tooltip" data-placement="top" title="Expand this chart to see more information"></i>
                        </div>
                        <div class="card-body">
                            <div class="prompt"><i class="fa fa-info-circle fa-2x"></i> <b>Select a Hospital Type to View this Chart</b></div>
                            <div class="col-md-12 chart" hidden>
                                <div id="outPatientChart" style="height:300px;"></div>
                                <div>
                                    <div class="form-check col-md-12">
                                        <input class="form-check-input " type="checkbox" value="" id="compareLastYear">
                                        <label class="form-check-label" for="compareLastYear">
                                            Compare with Previous Year
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-12">
                    <div class="card border border-primary bg-light" id="inPatientDiv">
                        <div class="card-header bg-primary text-white">
                            <i class="fa fa-star-o fa-pull-left fa-lg" id="starInpatientChart" data-toggle="tooltip" data-placement="top" title="Star this chart to place it on your dashboard"></i>
                            Inpatient Transfers
                            <i class="fa fa-expand fa-pull-right fa-lg" id="expandInpatientChart"></i>
                        </div>
                        <div class="card-body">
                            <div class="prompt"><i class="fa fa-info-circle fa-2x"></i> <b>Select a Hospital Type to View this Chart</b></div>
                            <div class="col-md-12">
                                <div class="chart" id="inPatientChart" style="height:300px;" hidden></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br />
            <div class="row">
                <div class="col-lg-12 col-md-12">
                    <div class="card border border-primary bg-light" id="surgeriesDiv" >
                        <div class="card-header bg-primary text-white">
                            <i class="fa fa-star-o fa-pull-left fa-lg" id="starSurgeriesChart" data-toggle="tooltip" data-placement="top" title="Star this chart to place it on your dashboard"></i>
                            Surgeries
                            <i class="fa fa-expand fa-pull-right fa-lg" id="expandSurgeriesChart" data-toggle="tooltip" data-placement="top" title="Expand this chart to see more information"></i>
                        </div>
                        <div class="card-body ">
                            <div class="prompt"><i class="fa fa-info-circle fa-2x"></i> <b>Select a Hospital Type to View this Chart</b></div>
                            <div class="col-md-12 ">
                                <div class="chart" id="surgeriesChart" style="height:300px;" hidden></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        var facilityTypeId = 0;
        var facilityId = 0;
        var providerId = 0;
        var startDate = '2019-01-01';
        var endDate = '2019-03-31';
        var showPreviousYear = 0;
        var pInput = document.getElementById("TextProvider");
        var providerAws;
        var outpatientTarget = 0;
        var inPatientTarget = 0;
        var surgeriesTarget = 0;
        var fInput;
        var facilityAws;
        var selectedHospitalTypesJson;
        var selectedHospitalTypes = [];
        var selectedHospitals = [];

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })

        $(document).ajaxStart(function () {
            $('#ajaxProgress').removeAttr('hidden');
        });
        $(document).ajaxStop(function () {
            $('#ajaxProgress').attr('hidden', true);
        });

    $(document).ready(function () {
        toastr.options = {
            'positionClass': 'toast-bottom-left',
        }
            fInput = document.getElementById("TextHospital");
            facilityAws = new Awesomplete(fInput, {
                minChars: 2,
            });
            providerAws = new Awesomplete(pInput, { minChars: 2, autoFirst: true });


            $('#hospital_types').multiselect({
                enableHTML: true,
                buttonWidth: '100%',
                includeSelectAllOption: true,
                allSelectedText: 'All Selected',
                buttonClass: 'btn btn-primary btn-block',
                buttonText: function (options, select) {
                    if (options.length === 0) {
                        return '<i class="fa fa-hospital-o fa-lg" aria-hidden="true"></i> Select Hospital Type';
                    }
                    else if (options.length > 3) {
                        return options.length + ' types selected';
                    }
                    else {
                        var labels = [];
                        options.each(function () {
                            if ($(this).attr('label') !== undefined) {
                                labels.push($(this).attr('label'));
                            }
                            else {
                                labels.push($(this).html());
                            }
                        });
                        return labels.join(', ') + '';
                    }
                },
                onDropdownHidden: function (event) {
                    selectedHospitalTypes = [];
                    $.each($('#hospital_types option:selected'), function () {
                        var a = new Object();
                        a.HealthFacilityTypeId = $(this).val();
                        selectedHospitalTypes.push(a);
                    });

                    selectedHospitalTypesJson = JSON.stringify(selectedHospitalTypes);
                    GetFacilityList(fInput, facilityAws, selectedHospitalTypesJson);
                }
            });
        });

        $(function () {
            var start = moment().startOf('year');
            var end = moment();

            function cb(start, end) {
                $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                startDate = start.format('YYYY-MM-DD');
                endDate = end.format('YYYY-MM-DD');

            }

            $('#reportrange').daterangepicker({
                startDate: start,
                endDate: end,
                alwaysShowCalendars: true,
                ranges: {
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
                    'Year to Date': [moment().startOf('year'), moment()],
                    'Last Year': [moment().startOf('year').subtract(1, 'year'), moment().endOf('year').subtract(1, 'year')]
                }
            }, cb);
            cb(start, end);
        });

        function SelectFacility() {
            var result = this.value.split("~");
            var healthFacilityName = result[1];
            var healthFacilityId = result[0];
            selectedHospitals.push(healthFacilityId);
            this.value = "";
            facilityId = healthFacilityId;

            
            $('#selectedFacilitiesTable > tbody:last-child').append
                ('<tr><td class="font-weight-bold">' + healthFacilityName + '</td><td><a href="#" onclick="updateTable(this,' + healthFacilityId + ');"><i class="fa fa-trash" ></i></a></td></tr>');
            $('#TextProvider').val('');
            providerId = 0;
            $("#allProviders").prop('checked', true);
            $('#TextProvider').attr('disabled', true);


        }

        function updateTable(row, removeId) {
            $(row).parent().parent().remove();
            selectedHospitals.splice($.inArray(removeId, selectedHospitals), 1);
            var t = document.getElementById("selectedFacilitiesTable");
            if (t.rows.length == 0) {
                $("#allHospitals").prop('checked', true);
                $("#allHospitals").change();
            }
        }

        function SelectProvider() {
            var r = this.value.split("~");
            this.value = r[1];
            providerId = r[0];

        }

        function GetProviders() {
            providerAws.destroy();
            pInput.addEventListener('awesomplete-selectcomplete', SelectProvider);
            providerAws = new Awesomplete(pInput, { minChars: 2, autoFirst: true });
            $.ajax({
                url: '../api/Providers/GetProviders/' + facilityId,
                type: 'GET',
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var providerList = [];
                    for (var i = 0; i < data.length; i++) {
                        providerList.push({ label: data[i]['ProviderName'], value: data[i]['ProviderID'] + '~' + data[i]['ProviderName'] });
                    }
                    providerAws.list = providerList;
                    console.log(providerList);
                }
            });
        }

        $("#allProviders").change(function () {
            if (this.checked) {
                $('#TextProvider').attr('disabled', true);
                $('#TextProvider').val('');
                providerId = 0;

            }
            else {
                $('#TextProvider').removeAttr('disabled');
                GetProviders();
            }
        });

        $("#allHospitals").change(function () {
            if (this.checked) {
                $('#TextHospital').attr('disabled', true);
                $('#TextHospital').val('');
                facilityId = 0;
                selectedHospitals = [];
                $('#selectedFacilitiesTable').empty();
                $('#selectedFacilitiesTable').append('<tbody></tbody>');
            }
            else {
                $('#TextHospital').removeAttr('disabled');
            }
        });

        $('#compareLastYear').change(function () {
            if (this.checked) {
                showPreviousYear = 1;
            }
            else {
                showPreviousYear = 0;
            }
            GetOutPatientEncounters();
        });


        function GetFacilityList(fInput, aws1, selectedFacilityTypes) {
            fInput.addEventListener('awesomplete-selectcomplete', SelectFacility);
            $.ajax({
                url: '../api/HealthFacilities/PostHealthFacilitiesByType',
                type: 'POST',
                data: selectedFacilityTypes,
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    var serverData = data;
                    var hfList = [];
                    for (var i = 0; i < serverData.length; i++) {
                        hfList.push({ label: serverData[i]['HealthFacilityName'], value: serverData[i]['ID'] + '~' + serverData[i]['HealthFacilityName'] });
                    }
                    aws1.list = hfList;
                },
                error: function (data) {
                    console.log(data);
                }
            });
        }

        function GetOutPatientEncounters() {
            var payload = [];
            var a = new Object();
            a.HealthFacilities = selectedHospitals;
            a.HealthFacilityTypes = selectedHospitalTypes;
            payload.push(a);
            payloadJson = JSON.stringify(payload);
            
            $('#outPatientDiv').removeAttr('hidden');
            $.ajax({
                type: 'POST',
                dataType: 'json',
                data: payloadJson,
                url: '../api/OutPatientEncounters/GetMonthlyTotals/?HealthFacilityID=' + facilityId
                    + '&ProviderID=' + providerId
                    + '&FromDate=' + startDate
                    + '&ToDate=' + endDate
                    + '&PreviousYear=' + showPreviousYear + '',
                contentType: "application/json; charset=utf-8",
            }).done(function (json) {

                var chartDataTargets = [];
                var lastYear = [];
                var lastYearTargets = [];
                var series1 = [];
                for (var i = 0; i < json.length; i++) {

                    series1.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['Total']]);
                    chartDataTargets.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), parseInt(json[i]['Target'])]);
                    if (showPreviousYear == 1) {
                        lastYear.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['TotalPreviousYear']]);
                        lastYearTargets.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), parseInt(json[i]['TargetPreviousYear'])]);
                    }
                }
                var chart = new Highcharts.chart('outPatientChart', {
                    chart: { type: 'areaspline' },
                    title: { text: '' },
                    subtitle: { text: '' },
                    yAxis: {
                        title: { text: 'Number of Visits' }
                    },
                    xAxis: {
                        type: 'datetime',
                        title: { text: '' }
                    },
                    series: [
                        { name: 'Outpatient Encounters', data: series1 },
                        { name: 'Target', data: chartDataTargets, type: 'line' },
                        //{ name: 'Last Year', data: lastYear },
                        //{ name: 'last-year-targets', data: lastYearTargets, type: 'line' }
                    ],
                    credits: false
                });

                if (lastYear.length > 0) {
                    chart.addSeries({
                        name: 'Last Year', data: lastYear
                    });
                }
            });

        }

        function GetInPatientEncounters() {
            var payload = [];
            var a = new Object();
            a.HealthFacilities = selectedHospitals;
            a.HealthFacilityTypes = selectedHospitalTypes;
            payload.push(a);
            payloadJson = JSON.stringify(payload);

            $('#inPatientDiv').removeAttr('hidden');
            $('#inpatientProgress').removeAttr('hidden');
            $.ajax({
                type: 'POST',
                dataType: 'json',
                data: payloadJson,
                url: '../api/InPatientEncounters/GetMonthlyTotals/?HealthFacilityID=' + facilityId
                    + '&ProviderID=' + providerId
                    + '&FromDate=' + startDate
                    + '&ToDate=' + endDate,
                contentType: "application/json; charset=utf-8"
            }).done(function (json) {

                var series13 = [];
                var series47 = [];
                var series8Plus = [];
                var seriesNotDischarged = [];
                var targets = []
                for (var i = 0; i < json.length; i++) {
                    series13.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['LOS13Total']]);
                    series47.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['LOS47Total']]);
                    series8Plus.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['LOS8Total']]);
                    seriesNotDischarged.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['LOSNDTotal']]);
                    targets.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['Target']]);
                }
                new Highcharts.chart('inPatientChart', {
                    chart: { type: 'column' },
                    title: { text: '' },
                    subtitle: { text: '' },
                    xAxis: {
                        type: 'datetime',
                        title: { text: '' }
                    },
                    yAxis: { title: { text: 'Number of Admissions' } },
                    series: [
                        { name: '1-3 days', data: series13 },
                        { name: '4-7 days', data: series47 },
                        { name: '8+ days', data: series8Plus },
                        { name: 'Not Discharged', data: seriesNotDischarged },
                        { name: 'Target', data: targets, type: 'line' }
                    ],
                    plotOptions: { series: { stacking: 'normal' } },
                    credits: false
                });
            });

        }

        function GetSurgeries() {
            var payload = [];
            var a = new Object();
            a.HealthFacilities = selectedHospitals;
            a.HealthFacilityTypes = selectedHospitalTypes;
            payload.push(a);
            payloadJson = JSON.stringify(payload);

            $('#surgeriesDiv').removeAttr('hidden');
            $.ajax({
                type: 'POST',
                dataType: 'json',
                data: payloadJson,
                url: '../api/Surgeries/GetMonthlyTotalsBySeverity/?HealthFacilityID=' + facilityId
                    + '&ProviderID=' + providerId
                    + '&FromDate=' + startDate
                    + '&ToDate=' + endDate
                    + '&PreviousYear=' + showPreviousYear + '',
                contentType: "application/json; charset=utf-8"
            }).done(function (json) {
                var seriesMinor = [];
                var seriesMajor = [];
                var targets = [];
                for (var i = 0; i < json.length; i++) {
                    seriesMinor.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['MinorSeverityTotal']]);
                    seriesMajor.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['MajorSeverityTotal']]);
                    targets.push([Date.UTC(json[i]['Year'], json[i]['MonthId'] - 1), json[i]['Target']]);
                }
                new Highcharts.chart('surgeriesChart', {
                    chart: { type: 'column' },
                    title: { text: '' },
                    subtitle: { text: '' },
                    xAxis: {
                        type: 'datetime',
                        title: { text: '' }
                    },
                    yAxis: { title: { text: 'Number of Surgeries' } },
                    series: [
                        { name: 'Minor', data: seriesMinor },
                        { name: 'Major', data: seriesMajor },
                        //{ name: 'Target', data: targets, type: 'line' }
                    ],
                    plotOptions: { series: { stacking: 'normal' } },
                    credits: false
                });
            });

        }

        function GetInventory() {
            if (facilityTypeId > 0) {
                $.ajax({
                    type: 'GET',
                    dataType: 'json',
                    url: '../api/HealthFacilities/GetFacilityInventory/' + facilityId,
                    contentType: "application/json; charset=utf-8"
                }).done(function (json) {
                    $('#NumberOfBeds').text(json['NumberOfBeds']);
                    $('#NumberOfClinics').text(json['NumberOfClinics']);
                    $('#NumberOfOperatingRooms').text(json['NumberOfOperatingRooms']);
                    outpatientTarget = json['NumberOfClinics'] * 25 * 4;
                    inPatientTarget = json['NumberOfBeds'] * 1.7;
                    surgeriesTarget = json['NumberOfOperatingRooms'] * 2 * 3;
                    GetFacilityList(fInput, aws1, facilityTypeId);
                    GetOutPatientEncounters();
                    GetInPatientEncounters();
                    GetSurgeries();
                    GetMonthlyAverage();
                });
            }
        }

        function GetTargets(
            TargetID = null,
            IndicatorID = null,
            HealthFacilityID = null,
            ProviderID = null,
            DomainLookupID = null,
            DirectorateLookupID = null,
            Year = null,
            Month = null
        ) {
            var url = '../api/targets';
            var params = '';
            if (TargetID) { params = params + '&TargetID=' + TargetID; }
            if (IndicatorID) { params = params + '&IndicatorID=' + IndicatorID; }
            if (HealthFacilityID) { params = params + '&HealthFacilityID=' + HealthFacilityID; }
            if (ProviderID) { params = params + '&ProviderID=' + ProviderID; }
            if (DomainLookupID) { params = params + '&DomainLookupID=' + DomainLookupID; }
            if (DirectorateLookupID) { params = params + '&DirectorateLookupID=' + DirectorateLookupID; }
            if (params) { url = url + '?' + params.substr(1); }
            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: url,
                contentType: "application/json; charset=utf-8"
            }).done(function (json) {
                return json;
            });
        }

        function refreshCharts() {
            if (selectedHospitalTypes.length > 0) {
                $('.prompt').attr('hidden', true);
                $('.chart').attr('hidden', false);
                GetOutPatientEncounters();
                GetInPatientEncounters();
                GetSurgeries();
            }
            else {
                toastr.warning('At least one hospital type must be selected');
            }
        }
    </script>
}
